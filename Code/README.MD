# How to use this R pipeline and reproduce results

This R code pipeline contains several different R Markdown files that should be run sequentially according their enumeration.

## Requirements 

* R version 4.1.2 
* R studio 2022.07.01 or above
* All data files necessary to run the R code (.biom files) are present in the “/Data" folder and are ready to be imported to R. These .biom files are generated by the QIIME2 pipeline present in the “Code/qiime2_preProcessing” folder

### R Package installation

The first chunk of script 1_Loading_and_pre_processing.Rmd has code to install the necessary packages locally (inside your “renv/” folder). You might need to restart R a couple times to install all the packages. The version of each package used in this pipeline present in the “renv.lock” file. You can run a series of commands from the renv package (like renv::restore()) to install the same versions of the same packages. This has not been extensively tested by the authors.

## Sequentially running the pipeline

* The numbered .Rmd (R Markdown) files should be executed sequentially. Run the entirity of script 1_Loading_and_pre_processing.Rmd before running script 2_beta_diversity.Rmd, etc.
* Each .Rmd script has numbered chunks that should also be run sequentially. They start loading libraries and data, and finish saving the R environment.
* Note that the saved session will be overwritten under the same name in the end of every script. in the end of script 8_important_taxa_overrepresentation.Rmd you will find an R enviroment with all objects produced by the code
* Each chunk has a unique number that refers to the script and may have subsessions. For example chunk 6.6.2 will be the second part of the sixth part of the sixth script
* Some parts of the code are heavily commented to facilitate understanding by new users of R and microbiome analyses. 

### Details about each script in the pipeline

* **1_Loading_and_pre_processing.Rmd:** After installing the packages with the first chunk, run all chunks. The code will then load, decontaminate, filter and normalize the data. Processed phyloseq objects that are ready to use in posterior analysis will be saved as .RData files. The input data is in the .biom format, and was generted in the qiime2 piepeline, whose code is available on the "Code\qiime2_preProcessing" folder.
* **2_beta_diversity.Rmd:** load necessary libraries and data with the first code chunk. The script will then perform beta diversity analysis (NMDS plots, permanovas, beta dispersion tests) on different portions of the dataset. The final chunk will save the full R session externally as an RData file. This file (“/R output/analysis_session.RData”) contains R objects that will be necessary for the subsequent analysis script.
* **3_alpha diversity.Rmd:** load necessary libraries and data with the first code chunk. The script will then perform alpha diversity analysis (Shannon diversity index plots, ANOVA tests, levene tests, post-hoc tests) on different portions of the dataset (such as all samples or only _A. thaliana_). The final chunk will *overwrite* the full R session externally as an RData file to be loaded on other analysis steps.
* **4a_neutral_models_rhizosphere.Rmd:** load necessary libraries and data with the first code chunk. The initial chunks also include some graphical aprameters for the plots. Chunks 4.6 to 4.6.3 will define neutral models for rhizosphere samples of _Brassica oleracea_, and also extract neutral model metrics like R2, m, and percentages of ASVs above and below neutrality. 

Most importantly, one neutral model will be calculated for each of the four experimental treatments (n=6 for each treatment) in _B. oleracea_. The metacommunity for the pool parameter of the tyRa::fit_sncm() function will include all 24 samples of _B. oleracea_. Chunks 4.6.4 to 4.6.8 will add the neutral model fit class to the phyloseq object, which is used for further subsetting. Overlaps of above-neutral ASVs can be seen on the last chunk of this series. The whole 4.7 chunk series will perform the same analysis, but for _A. thaliana_. I apologize, dear reader, for not automating this task. 

Chunks 4.8 to 4.9.6 will check for possibly introduced biases in this analysis. Most importantly, chunk 4.9.1 will run 1000 permanovas using random ASVs instead of above-neutral ASVs. Chunks 4.9.2 to 3.9.5 will extract and re-shape p/R2/F values for the 1000 permanovas, and chunk 4.6 will plot these results. Chunk 4.10 will use the metacoder package to prepare the matrixes of heat trees. Chunk 4.12 will calculate the local regressions between above-neutral ASVs and the full communities, which are exported as plots in chunk 4.13. In the end of the script, overwrites the R image to be loaded in the next script. 
* **4b_neutral_models_endosphere:** This script is identical to 4a_neutral_models_rhizosphere.Rmd in structure and output, but it targets endosphere samples. I apologize again, dear reader, for not automating this. In the end of the script, overwrites the R image to be loaded in the next script. 
* **5_differential_abundance.Rmd:** load necessary libraries and data with the first code chunk. The script will then perform differential abudance analysis. Chunk 5.3 will construct the heatmaps of differentially abudannt ASVs. In the end of the script, overwrites the R image to be loaded in the next script
* **6_network_analysis.Rmd:** load necessary libraries and data with the first code chunk. This script relies heavily on custom functions that load in chunk 6.1 and  are found in  “./Code/Functions/Network_custom_functions.R". The script will then proceed to perform network analysis, including calculation of the network, calculation of network metrics, comparisons with random networks, and calculation of node metrics. Chunk 6.8 will export data as .csv files to be load on Cystoscape for network visualization. All these processed files, including the cytoscape network visualization in "R output/Network files/MeJA_pilot_networks.cys" are present in “/R output/Network files/”. In the end of the script, overwrites the R image to be loaded in the next script.
* **7_random_forest.Rmd:** load necessary libraries and data with the first code chunk. The script will then create random forest models to select ASVs that can predict the different treatments within each stress/species combination, and also calculate confusion matrices to determine prediciton accuracies. RF importance is added to the phyloseq objects in chunk 7.4, and plots are exported on chunk 7.7. In the end of the script, overwrites the R image to be loaded in the next script.
* **8_important_taxa_overrepresentation.Rmd:** load necessary libraries and data with the first code chunk. The script will then make a phyloseq object that only contains the "important" ASVS and make the fisher proportion tests for each taxonomy. Chunk 8.1 will subset the ASVs tagged as important in scripts 5,6 and 7. Chunk 8.2 will load and execute a function to calculate the fisher proportions on all taxa at all taxonomic levels. Chunk 8.3 will extract key metrics from the fisher test, and chunk 8.4 will put these metrics into heat trees. In the end, saves the final analysis session for the microbiome data analysis.
* **9_plant_traits.Rmd:** install and load additional packages, then load and prepare plant phenotype data. Chunks 9.2 to 9.7 will run analysis, checks and plots for plant phenotypes (such as plant dry weight)


### Key custom functions executed in theses scripts

Some of these functions have some hard-coded variables within them, and may need adjustments to be reproduced on different datasets.

The **histogram of 1000 permanovas’r, f and p values**, compared to the full community and above-neutral community, can be reproduced with the code on chunks 4a.9 to 4a.9.6
* it's main custom function is called thousand_permanovas_on_random_otu(). It will calculate a permanovas, drawing a number of random ASVs from the full community equal to the number of ASVs found as above-neutral in the four treatments, and then merging them into a single phyloseq object that will be used to calculate the permanova. the process is repeated 1000 times and the output si a list of 1000 permanovas. is has 2 input phyloseq objects as arguments:
    * CSS_fraction = a phyloseq object with one of the four data paritions (per plant species and soil type). Essentially, this includes all ASVs of a particular sample subset.
    * ps_4_model_l = a list of four phyloseq objects, split by the four JA-induction treatments, that contains the ASVs classified as above expected by the neutral models within a particular data partitions. Essentially, this includes the above-neutral ASVs within each treatment that is found in the particular sample subset defined in "CSS_fraction"
    * When adjusting this function to be run in another dataset, you may need to change the number of treatments, their names, and the name of the variable that stores the treatment conditions. Note that using the function replicate() might be far more efficient than the function made available with this code.

The **local regression between the diversity of above-neutral ASVs and the full community**, at every taxa level, can be reproduced with the code on chunk 4a.12
* it's main custom function is called diversity_per_taxon().  this function provides alpha diversity indexes of each taxon in a phyloseq object as a dataframe and has 3 inputs as arguments:
    * ps_object = one phyloseq object
    * taxa_level = a QUOTED taxonomic level in your phyloseq object, like Class or Order
    * data_partition = a QUOTED label for column names
    * This function has to be run once for each taxonomic level (class, family, order)
    * in each taxonomic level, this function is run in the full community of a particular sample set (such as rhizosphere of A. thaliana) and in the above-neutral ASV subset from the same sample set
    * the following section in the script will join the dataframes of per-taxon alpha diversity metrics from the full community
    * finally, the plot_observed_correlation() function will take this joined dataframe and plot the local regression, with labels for each taxa for the observed number of taxa. The custom functions plot_shannon_correlation and plot_simpson_correlation will do the same for the Shannon and Simpson diversity indexes. Apologies for the repetitive hard-coding present there.

The **Fisher tests summary** can be reproduced by running chunks 8.1 to 8.4. Chunk 8.1 will simply put all important ASVS (tagged by differential abundance, network analysis, network analysis) into a single phyloseq object for each data partition (according plant species and soil type)
* it's main custom for this pipeline is called fisher_result_l(), reproduced in chunk 8.2. It will calculate fisher proportion test between all taxa found in two phyloseq objects that are used as inputs (and arguments) the output is a per-taxa list of fisher proportion tests. The input arguments are:
    * ps_important_taxa = A phyloseq object that contains all the “important” ASVs to be compared to the full community
    * ps_all_taxa = a phyloseq object with the full microbial community
    * chunk 8.3 will perform an fdr correction on the p values. The other parts of this chunk are checks for close inspection of the raw results
* chunk 8.4 will use the function fisher_to_heatTree() to visualize the fisher test results. It will extract p values and odds ratio values from the per-taxon list of fisher tests, and represent them as color and node sizes of a heat tree with the same taxons. It’s two input arguments are: 
    * fisher_output_l = the output of fisher_result_l() function after fdr correction in chunk 8.3
    * fisher_ps_important_taxa_l_l = a phyloseq object with them “important ASVs” whose proportion against the full community was tested in the fisher_result_l() function
    * when using this function on other datasets, verify that the kingdom to genus taxonomy is present in the taxonomy table of the phyloseq object as columns 1 to 6. 

Several custom functions used on **network analysis** can be found on "./Code/Functions/Network_custom_functions.R". please refer to comments on each function within that file for their use

### Running these analysis in your own datasets

Much of the code used here relies on sample metadata information that has been hard-coded. This has be changed to run this analysis on your own microbiome data.  Most importantly:
* The sample metadata column "Plant_species" differentiates _A. thaliana_ and B. oleracea_
* The sample metadata column "Sample_type"  differentiates Root (endophytic) and Soil (rhizospheric) samples
* The sample metadata column "MeJA_treatment" differentiates the JA-induction treatments: MeJA 1mM, MeJA 0.1mM, Caterpillar oral secretion, and control samples

Some of the custom functions in this script rely on this hard-coded metadata. To run this analysis on your onw datasets, some of these functions have to be adjusted.

The code to calcuate the 1000 permanovas (chunks 4a.9 and 4b.9), networks (chunk 6.2), and random forest (chunks 7.1 and 7.3) can take a while to compute. Networks took up to 2h in a 2016 HP Zbook with 4 cores and 16GB ram.

